# 迭代式自动标注系统使用指南

## 🎯 系统概述

这是一个**自我进化的数据标注系统**，通过迭代训练不断提升模型性能，大幅减少手动标注工作量。

## 📊 工作流程

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  迭代 0：手动标注 20-30 张 → 训练初始模型              │
│     ↓                                                   │
│  迭代 1：自动标注 100 张 → 人工审核 → 重新训练         │
│     ↓                                                   │
│  迭代 2：自动标注 200 张 → 人工审核 → 重新训练         │
│     ↓                                                   │
│  迭代 N：数据集越来越大，模型越来越准                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 🚀 快速开始

### 1. 安装依赖

```bash
cd e:\works\DAMN
pip install -r requirements_yolo.txt
```

### 2. 启动系统

```bash
python start_annotation_system.py
```

### 3. 首次使用流程

**步骤 1：采集原始图片**
- 运行游戏
- 选择"1. 采集原始图片"
- 按回车开始自动截图
- 建议采集 100-200 张图片

**步骤 2：手动标注初始样本**
- 选择"2. 手动标注"
- 使用 yolo_editor 或 labelImg 标注
- 至少标注 20-30 张（越多越好）
- 标注保存在 `dataset/manual_annotations/`

**步骤 3：训练初始模型**
- 选择"3. 训练模型"
- 等待训练完成（约 10-30 分钟）
- 模型保存在 `runs/detect/iteration_1/weights/best.pt`

**步骤 4：自动标注**
- 选择"4. 自动标注"
- 系统自动标注所有未处理的图片
- 标注保存在 `dataset/auto_annotations/`

**步骤 5：人工审核**
- 选择"5. 审核标注"
- 三种审核方式：
  - 可视化工具：逐张查看，Space接受/D删除
  - 编辑器：精细调整边界框
  - 批量接受：自动接受高置信度标注
- 审核通过的移动到 `dataset/reviewed/`

**步骤 6：重复迭代**
- 选择"6. 运行完整迭代"自动执行 3→4→5
- 每次迭代，模型性能都会提升

## 📁 目录结构

```
dataset/
├── raw_images/              # 原始截图
├── manual_annotations/      # 手动标注（高质量）
├── auto_annotations/        # 自动标注（待审核）
├── reviewed/                # 已审核标注（高质量）
├── yolo/                    # YOLO训练数据
│   ├── data.yaml           # 数据集配置
│   ├── images/
│   │   ├── train/          # 训练图片
│   │   └── val/            # 验证图片
│   └── labels/
│       ├── train/          # 训练标注
│       └── val/            # 验证标注
└── iteration_config.json    # 迭代记录

runs/detect/
├── iteration_1/             # 第1次迭代模型
├── iteration_2/             # 第2次迭代模型
└── ...
```

## 🛠️ 工具脚本

### 1. iterative_annotation_system.py
主系统，包含所有功能

### 2. quality_checker.py
检查标注质量

```bash
python scripts/quality_checker.py
```

检测：
- ❌ 缺失的标注/图片
- ❌ 空标注文件
- ❌ 格式错误
- ❌ 框超出边界
- ❌ 框太小/太大
- ❌ 重复标注

### 3. visualize_annotations.py
可视化标注结果

```bash
python scripts/visualize_annotations.py
```

## 💡 最佳实践

### 标注策略

1. **首次手动标注（迭代0）**
   - 标注 20-30 张代表性图片
   - 包含各种场景：不同模块、不同角度、不同光照
   - 保证标注质量（比数量更重要）

2. **设置合理阈值**
   - 训练初期：confidence_threshold = 0.5
   - 模型成熟后：可降低到 0.3 获取更多候选
   - review_threshold = 0.7（低于此值需人工审核）

3. **审核重点**
   - 优先审核低置信度标注
   - 关注新出现的场景
   - 修正边界框位置和类别

4. **迭代节奏**
   - 迭代1-3：每次100张，重点提升模型基础能力
   - 迭代4-6：每次200-500张，扩充数据多样性
   - 迭代7+：批量处理，只审核低置信度样本

### 训练参数

```python
# 首次训练（迭代0）
epochs = 50
imgsz = 640
batch = 16

# 后续训练（迭代1+）
epochs = 30  # 可以减少，因为从上次模型继续训练
imgsz = 640
batch = 16
```

## 📈 性能指标

查看训练结果：

```bash
# 查看最新训练结果
cd runs/detect/iteration_X
cat results.csv

# 可视化指标
python scripts/visualize_training.py
```

关键指标：
- **mAP50**：平均精度（越高越好，>0.8为优秀）
- **Precision**：精确率（越高越好）
- **Recall**：召回率（越高越好）

## 🔄 典型迭代示例

### 迭代 0（人工基础）
- 手动标注：30 张
- 训练时间：15 分钟
- mAP50：0.65
- 成果：初始模型

### 迭代 1（首次自动）
- 自动标注：100 张
- 人工审核：80 张合格
- 总数据：110 张
- mAP50：0.75 ↑
- 成果：性能提升 15%

### 迭代 2（加速扩充）
- 自动标注：200 张
- 人工审核：150 张合格
- 总数据：260 张
- mAP50：0.82 ↑
- 成果：性能提升 9%

### 迭代 3（稳定提升）
- 自动标注：500 张
- 人工审核：400 张合格
- 总数据：660 张
- mAP50：0.88 ↑
- 成果：性能提升 7%

## ❓ 常见问题

### Q1: 自动标注结果很差怎么办？
A: 初期很正常。解决方法：
1. 增加手动标注数量（至少30张）
2. 延长训练时间（增加epochs）
3. 检查类别定义是否清晰

### Q2: 如何判断何时停止迭代？
A: 满足以下条件之一即可停止：
- mAP50 > 0.85
- 连续两次迭代性能提升 < 2%
- 数据集规模 > 1000 张

### Q3: 如何处理类别不平衡？
A: 
- 针对少数类别多采集图片
- 在审核时优先接受少数类别标注
- 使用数据增强

### Q4: 可以中途修改类别吗？
A: 可以，但需要：
1. 更新 `dataset/yolo/data.yaml`
2. 重新标注已有数据
3. 从头开始训练

## 🎓 进阶技巧

### 1. 并行标注
多人协作时，分配不同的图片子集，最后合并

### 2. 主动学习
优先标注模型最不确定的样本（低置信度）

### 3. 数据增强
在训练时自动应用：
- 翻转、旋转
- 亮度、对比度调整
- 噪声添加

### 4. 模型融合
保留多个迭代的模型，使用投票机制

## 📞 技术支持

遇到问题？检查：
1. 日志文件：`dataset/iteration_config.json`
2. 训练日志：`runs/detect/iteration_X/train.log`
3. 质量报告：`annotation_quality_report.json`

---

💡 **记住：质量 > 数量。20张高质量标注胜过100张低质量标注！**
